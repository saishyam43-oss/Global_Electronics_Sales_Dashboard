ðŸ”µ CUSTOMER COUNT & SEGMENTATION
/*
    Measure: Total Customers
    Old Name: Total Customers
    Purpose: Counts unique customers who appear in the sales table.
*/
Total Customers :=
DISTINCTCOUNT('sales_final'[CustomerKey])

/*
    Measure: Active Customers
    Old Name: Active Customers
    Purpose: Number of customers with at least one order in the selected period.
*/
Active Customers :=
CALCULATE(
    DISTINCTCOUNT('sales_final'[CustomerKey]),
    'sales_final'
)

/*
    Measure: At-Risk Customers
    Old Name: At-Risk Customers
    Purpose: Counts customers in the "At-Risk" recency bucket.
*/
At-Risk Customers :=
CALCULATE(
    DISTINCTCOUNT('customers'[CustomerKey]),
    'customers'[Recency Bin] = "At-Risk"
)

/*
    Measure: Dormant Customers
    Old Name: Dormant Customers
    Purpose: Counts customers who have not purchased for the longest period.
*/
Dormant Customers :=
CALCULATE(
    DISTINCTCOUNT('customers'[CustomerKey]),
    'customers'[Recency Bin] = "Dormant"
)


ðŸ”µ CUSTOMER VALUE METRICS (CLV, AOV, RFM)
/*
    Measure: Customer Lifetime Value
    Old Name: CLTV
    Purpose: Total revenue generated by each customer. Core metric for retention analysis.
*/
Customer Lifetime Value :=
SUMX(
    VALUES('customers'[CustomerKey]),
    CALCULATE([Revenue Total])
)

/*
    Measure: Average Customer Lifetime Value
    Old Name: Avg CLTV
    Purpose: Returns average CLV across the selected customer group.
*/
Average Customer Lifetime Value :=
AVERAGEX(VALUES('customers'[CustomerKey]), [Customer Lifetime Value])

/*
    Measure: RFM Monetary Value
    Old Name: Monetary (RFM)
    Purpose: Total revenue used as the "monetary" component in RFM analysis.
*/
RFM Monetary Value :=
CALCULATE([Revenue Total])


ðŸ”µ RFM SCORES (Recency, Frequency, Monetary)
/*
    Measure: RFM Recency Days
    Old Name: Recency Days
    Purpose: Days since each customer's last purchase.
*/
RFM Recency Days :=
DATEDIFF(
    MAX('sales_final'[OrderDate]),
    MAX('Calendar'[Date]),
    DAY
)

/*
    Measure: RFM Frequency
    Old Name: Frequency (Orders)
    Purpose: Number of orders placed by each customer.
*/
RFM Frequency :=
CALCULATE(COUNTROWS('sales_final'))

/*
    Measure: RFM Monetary
    Old Name: Monetary (RFM)
    Purpose: Sum of spending by each customer.
*/
RFM Monetary :=
SUM('sales_final'[Revenue])


ðŸ”µ Acquisition & Retention
/*
    Measure: New Customers (Period)
    Old Name: New Customers
    Purpose: Customers whose first purchase date falls inside the selected date range.
*/
New Customers :=
CALCULATE(
    DISTINCTCOUNT('customers'[CustomerKey]),
    'customers'[First Purchase Date (Column)]
)

/*
    Measure: Returning Customers
    Old Name: Returning Customers
    Purpose: Counts customers with more than one purchase.
*/
Returning Customers :=
CALCULATE(
    DISTINCTCOUNT('customers'[CustomerKey]),
    FILTER(
        VALUES('customers'[CustomerKey]),
        CALCULATE(COUNTROWS('sales_final')) > 1
    )
)

/*
    Measure: Retention Rate Percentage
    Old Name: Retention %
    Purpose: Percentage of customers who made repeat purchases.
*/
Retention Rate Percentage :=
DIVIDE([Returning Customers], [Total Customers])


ðŸ”µ CUSTOMER BEHAVIOR BY AGE & GENDER
/*
    Measure: Revenue by Age Group
    Old Name: Revenue (Age Group)
    Purpose: Total revenue contributed by each age segment.
*/
Revenue by Age Group :=
CALCULATE([Revenue Total], 'customers'[Age Group])

/*
    Measure: Profit by Age Group
    Old Name: Profit (Age Group)
    Purpose: Profit contribution by customer age segments.
*/
Profit by Age Group :=
CALCULATE([Profit Total], 'customers'[Age Group])

/*
    Measure: CLTV by Age Group
    Old Name: CLTV (Age Group)
    Purpose: Shows lifetime value differences across age demographics.
*/
CLTV by Age Group :=
CALCULATE([Customer Lifetime Value], 'customers'[Age Group])

/*
    Measure: AOV by Age Group
    Old Name: AOV (Age Group)
    Purpose: Highlights average order value differences across groups.
*/
AOV by Age Group :=
CALCULATE([Average Order Value], 'customers'[Age Group])

/*
    Measure: Revenue by Gender
    Old Name: Revenue (Gender)
    Purpose: Male vs. Female revenue contribution.
*/
Revenue by Gender :=
CALCULATE([Revenue Total], 'customers'[Gender])

/*
    Measure: Profit by Gender
    Old Name: Profit (Gender)
    Purpose: Profit split between genders.
*/
Profit by Gender :=
CALCULATE([Profit Total], 'customers'[Gender])


ðŸ”µ CUSTOMER COHORT ANALYSIS
/*
    Measure: Cohort Retention Percentage
    Old Name: Retention % (Cohort)
    Purpose: Shows what percentage of a cohort remains active over time.
*/
Cohort Retention Percentage :=
DIVIDE(
    DISTINCTCOUNT('sales_final'[CustomerKey]),
    CALCULATE(
        DISTINCTCOUNT('customers'[CustomerKey]),
        ALL('Calendar'),
        VALUES('customers'[Cohort Month])
    )
)

/*
    Measure: Cohort Customer Count
    Old Name: Cohort Count
    Purpose: Total customers acquired in each cohort month.
*/
Cohort Customer Count :=
CALCULATE(
    DISTINCTCOUNT('customers'[CustomerKey]),
    ALL('Calendar'),
    VALUES('customers'[Cohort Month])
)


ðŸ”µ CUSTOMER SEGMENT DONUT (Active, At-Risk, Dormant)
/*
    Measure: Active Customer Percentage
    Old Name: Active %
    Purpose: Percentage of customers currently active.
*/
Active Customer Percentage :=
DIVIDE([Active Customers], [Total Customers])

/*
    Measure: At-Risk Customer Percentage
    Old Name: At-Risk %
    Purpose: % share of customers slipping into the at-risk bucket.
*/
At-Risk Customer Percentage :=
DIVIDE([At-Risk Customers], [Total Customers])

/*
    Measure: Dormant Customer Percentage
    Old Name: Dormant %
    Purpose: Percentage of customers who have churned or gone inactive.
*/
Dormant Customer Percentage :=
DIVIDE([Dormant Customers], [Total Customers])